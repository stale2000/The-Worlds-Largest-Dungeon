---
/**
 * ChatInterface.astro
 * Main chat UI component for interacting with the WLD chat API.
 *
 * DESIGN SYSTEM: Mnehmos (Copper/Stone)
 * - Primary: Copper (#b87333)
 * - Backgrounds: Stone/Carbon (#1c1917, #292524)
 * - Fonts: Space Grotesk (Headers), Inter (Body)
 */

import { marked } from "marked";

interface Props {
  placeholder?: string;
  welcomeMessage?: string;
}

const {
  placeholder = "Ask about the dungeon, rules, monsters...",
  welcomeMessage = "Welcome, adventurer. I am the Dungeon Master. The World's Largest Dungeon awaits your party. What do you seek?",
} = Astro.props;
---

<!-- Import Mnehmos Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap"
  rel="stylesheet"
/>

<div class="chat-interface" id="chat-interface">
  <!-- Main Chat Area -->
  <div class="chat-main">
    <!-- Message History -->
    <div
      class="chat-messages"
      id="chat-messages"
      role="log"
      aria-live="polite"
      aria-label="Chat messages"
    >
      <!-- Welcome message -->
      <div class="message-row message-system-row">
        <div class="message message-system">
          <div class="message-identity">
            <div class="avatar system-avatar">üè∞</div>
            <span class="sender-name">System</span>
          </div>
          <div class="message-content">
            <p>{welcomeMessage}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <form class="chat-input-form" id="chat-form">
      <div class="input-wrapper">
        <label for="chat-input" class="visually-hidden">Your message</label>
        <textarea
          id="chat-input"
          name="message"
          class="chat-input"
          placeholder={placeholder}
          rows="1"
          required
          aria-describedby="input-hint"></textarea>
        <span id="input-hint" class="visually-hidden"
          >Press Enter to send, Shift+Enter for new line</span
        >
      </div>
      <button
        type="submit"
        class="chat-submit"
        id="chat-submit"
        aria-label="Send message"
      >
        <span class="submit-icon">‚öîÔ∏è</span>
        <span class="submit-text">Send</span>
      </button>
    </form>

    <!-- Loading Indicator -->
    <div class="chat-loading" id="chat-loading" aria-hidden="true">
      <div class="loading-spinner"></div>
      <span>The dungeon master is pondering...</span>
    </div>

    <!-- Error Display -->
    <div class="chat-error" id="chat-error" role="alert" aria-hidden="true">
      <span class="error-icon">‚ö†Ô∏è</span>
      <span class="error-message" id="error-message"></span>
      <button
        class="error-dismiss"
        id="error-dismiss"
        aria-label="Dismiss error">√ó</button
      >
    </div>
  </div>

  <!-- Source Sidebar -->
  <aside class="source-sidebar" id="source-sidebar" aria-label="Source Details">
    <div class="sidebar-header">
      <h3>Source Details</h3>
      <button
        class="sidebar-close"
        id="sidebar-close"
        aria-label="Close sidebar">√ó</button
      >
    </div>
    <div class="sidebar-content" id="sidebar-content">
      <div class="sidebar-empty">
        <span class="empty-icon">üìú</span>
        <p>Select a source number from the chat to view details here.</p>
      </div>
    </div>
  </aside>
</div>

<style>
  /* === MNEHMOS DESIGN TOKENS === */
  :root {
    --copper: #b87333;
    --copper-light: #d4956a;
    --stone-900: #1c1917; /* Main BG */
    --stone-800: #292524; /* Elevated BG */
    --stone-700: #44403c; /* Borders */
    --stone-200: #e7e5e4; /* Text Main */
    --stone-400: #a8a29e; /* Text Muted */

    --font-display: "Space Grotesk", sans-serif;
    --font-body: "Inter", sans-serif;
  }

  .chat-interface {
    display: flex;
    flex-direction: row;
    height: 100%;
    min-height: 600px;
    max-height: calc(100vh - 100px);
    background: var(--stone-900);
    border: 1px solid var(--stone-700);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    font-family: var(--font-body);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  }

  /* Main Chat Area */
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    position: relative;
    background: radial-gradient(
      circle at top right,
      rgba(184, 115, 51, 0.05),
      transparent 40%
    );
  }

  /* Messages Area */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    scrollbar-width: thin;
    scrollbar-color: var(--stone-700) var(--stone-900);
  }

  /* Webkit Scrollbar */
  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }
  .chat-messages::-webkit-scrollbar-track {
    background: var(--stone-900);
  }
  .chat-messages::-webkit-scrollbar-thumb {
    background-color: var(--stone-700);
    border-radius: 3px;
  }

  /* === MESSAGE ROWS (Fix Alignment) === */
  :global(.message-row) {
    display: flex;
    width: 100%;
    margin-bottom: 2px; /* Slight spacing */
  }

  :global(.message-user-row) {
    justify-content: flex-end; /* FORCE RIGHT */
  }

  :global(.message-assistant-row) {
    justify-content: flex-start; /* FORCE LEFT */
  }

  :global(.message-system-row) {
    justify-content: center;
  }

  /* === SIDEBAR STYLING === */
  /* (Static elements stay scoped) */
  .source-sidebar {
    width: 0;
    background: var(--stone-800);
    border-left: 1px solid var(--stone-700);
    display: flex;
    flex-direction: column;
    transition: width 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
  }
  /* ... sidebar styling continues ... */

  /* === MESSAGE BUBBLES === */
  :global(.message) {
    display: flex;
    gap: 1rem;
    max-width: 85%;
    animation: messageSlideIn 0.3s ease;
    align-items: flex-start;
  }

  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* User Message (Right) */
  :global(.message-user) {
    flex-direction: row-reverse; /* Avatar on right */
  }

  /* Assistant Message (Left) */
  :global(.message-assistant) {
    flex-direction: row; /* Avatar on left */
  }

  :global(.message-system) {
    align-self: center;
    flex-direction: column;
    align-items: center;
    max-width: 80%;
  }

  /* Identity Column */
  :global(.message-identity) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    width: 60px;
    flex-shrink: 0;
  }

  :global(.avatar) {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s;
  }

  :global(.avatar:hover) {
    transform: scale(1.05);
  }

  :global(.user-avatar) {
    background: linear-gradient(135deg, var(--copper), var(--copper-light));
    color: white;
    border: 2px solid #fff;
  }

  :global(.assistant-avatar) {
    background: var(--stone-800);
    color: var(--copper);
    border: 2px solid var(--copper);
  }

  :global(.system-avatar) {
    background: transparent;
    border: 1px dashed var(--stone-700);
    color: var(--stone-400);
  }

  :global(.sender-name) {
    font-size: 0.65rem;
    color: var(--stone-400);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-align: center;
  }

  /* Content Bubble */
  :global(.message-content) {
    padding: 1.25rem;
    border-radius: 12px;
    line-height: 1.6;
    flex: 1;
    min-width: 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  :global(.message-user .message-content) {
    background: linear-gradient(135deg, var(--stone-800), var(--stone-900));
    color: white;
    border: 1px solid var(--stone-700);
    border-top-right-radius: 0;
  }

  :global(.message-assistant .message-content) {
    background: var(--stone-800);
    border: 1px solid var(--stone-700);
    border-left: 2px solid var(--copper); /* Accent border */
    border-top-left-radius: 0;
  }

  :global(.message-system .message-content) {
    background: rgba(255, 255, 255, 0.03);
    border: 1px dashed var(--stone-700);
    text-align: center;
    color: var(--stone-400);
    font-style: italic;
  }

  :global(.message-content p) {
    margin: 0;
  }
  :global(.message-content p + p) {
    margin-top: 0.75rem;
  }

  /* === MARKDOWN TYPOGRAPHY === */
  :global(.markdown-content) {
    color: var(--stone-200);
    font-size: 1rem;
  }

  :global(.markdown-content h1),
  :global(.markdown-content h2),
  :global(.markdown-content h3) {
    color: white;
    font-family: var(--font-display);
    font-weight: 700;
    margin: 1.5rem 0 0.75rem 0;
    line-height: 1.2;
  }

  :global(.markdown-content h1) {
    font-size: 1.75rem;
    border-bottom: 2px solid var(--copper);
    padding-bottom: 0.5rem;
    display: inline-block;
  }
  :global(.markdown-content h2) {
    font-size: 1.4rem;
    color: var(--copper-light);
  }
  :global(.markdown-content h3) {
    font-size: 1.15rem;
    color: var(--stone-200);
  }

  :global(.markdown-content strong) {
    color: var(--copper);
    font-weight: 600;
  }

  :global(.markdown-content ul),
  :global(.markdown-content ol) {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  :global(.markdown-content li) {
    margin: 0.5rem 0;
    color: var(--stone-200);
  }

  :global(.markdown-content li::marker) {
    color: var(--copper);
  }

  /* Code Blocks */
  :global(.markdown-content code) {
    background: rgba(0, 0, 0, 0.3);
    color: var(--copper-light);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: "Consolas", monospace;
    font-size: 0.9em;
  }

  :global(.markdown-content pre) {
    background: #000;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--stone-700);
    overflow-x: auto;
    margin: 1rem 0;
  }

  :global(.markdown-content pre code) {
    background: none;
    padding: 0;
    color: var(--stone-200);
  }

  :global(.markdown-content blockquote) {
    border-left: 4px solid var(--copper);
    background: rgba(184, 115, 51, 0.05); /* Tint of copper */
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    font-style: italic;
    color: var(--stone-400);
    border-radius: 0 8px 8px 0;
  }

  /* Sources Helper */
  :global(.message-sources) {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--stone-700);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  :global(.sources-label) {
    font-family: var(--font-display);
    font-size: 0.75rem;
    color: var(--stone-400);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: 4px;
  }

  :global(.source-btn) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    min-width: 24px;
    padding: 0 8px;
    background: var(--stone-800);
    color: var(--copper);
    border: 1px solid var(--copper);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
  }

  :global(.source-btn:hover) {
    background: var(--copper);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(184, 115, 51, 0.3);
  }

  /* Tool Badge */
  :global(.tool-badge) {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: 8px;
    border: 1px solid transparent;
  }

  :global(.tool-badge.sqlite) {
    background: rgba(255, 255, 255, 0.05);
    color: var(--stone-400);
    border-color: var(--stone-700);
  }
  :global(.tool-badge.rag) {
    background: rgba(184, 115, 51, 0.1);
    color: var(--copper);
    border-color: var(--copper);
  }
  :global(.tool-badge.both) {
    background: linear-gradient(
      135deg,
      rgba(184, 115, 51, 0.2) 0%,
      rgba(0, 0, 0, 0.2) 100%
    );
    color: white;
    border-color: var(--copper-light);
  }

  /* Input Form */
  .chat-input-form {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--stone-800);
    border-top: 1px solid var(--stone-700);
  }

  .input-wrapper {
    flex: 1;
    position: relative;
  }

  .chat-input {
    width: 100%;
    padding: 1rem;
    background: var(--stone-900);
    border: 1px solid var(--stone-700);
    border-radius: 8px;
    color: white;
    font-family: var(--font-body);
    font-size: 1rem;
    resize: none;
    min-height: 56px;
    max-height: 150px;
    transition: all 0.2s;
  }

  .chat-input::placeholder {
    color: var(--stone-400);
  }

  .chat-input:focus {
    outline: none;
    border-color: var(--copper);
    box-shadow: 0 0 0 2px rgba(184, 115, 51, 0.2);
  }

  .chat-submit {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0 2rem;
    background: linear-gradient(135deg, var(--copper), var(--copper-light));
    border: none;
    border-radius: 8px;
    color: white;
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
  }

  .chat-submit:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(184, 115, 51, 0.4);
  }

  .chat-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(1);
  }

  /* Loading */
  .chat-loading {
    position: absolute;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.5rem;
    background: var(--stone-800);
    border: 1px solid var(--copper);
    border-radius: 30px;
    font-size: 0.85rem;
    color: var(--copper-light);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    z-index: 10;
  }

  .chat-loading.visible {
    display: flex;
    animation: slideUpFade 0.3s ease;
  }

  @keyframes slideUpFade {
    from {
      opacity: 0;
      transform: translate(-50%, 10px);
    }
    to {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }

  .loading-spinner {
    width: 18px;
    height: 18px;
    border: 2px solid transparent;
    border-top-color: var(--copper);
    border-right-color: var(--copper);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Error */
  .chat-error {
    position: absolute;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 500px;
    display: none;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: rgba(127, 29, 29, 0.9);
    border: 1px solid #ef4444;
    border-radius: 8px;
    color: white;
    z-index: 20;
    backdrop-filter: blur(8px);
  }

  .chat-error.visible {
    display: flex;
    animation: slideDownFade 0.3s ease;
  }

  @keyframes slideDownFade {
    from {
      opacity: 0;
      transform: translate(-50%, -20px);
    }
    to {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .chat-interface {
      flex-direction: column;
    }
    .source-sidebar {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
    }
    .source-sidebar.open {
      width: 85%;
    }
  }
</style>

<script>
  /**
   * Chat Interface Client-Side Logic
   * Handles form submission, API calls, message rendering, and sidebar control.
   */

  import { marked } from "marked";

  // Configure marked with GFM
  marked.setOptions({ breaks: true, gfm: true });

  const CHAT_API_URL = import.meta.env.CHAT_API_URL || "http://localhost:8080";

  // DOM Elements
  const chatMessages = document.getElementById("chat-messages");
  const chatForm = document.getElementById("chat-form") as HTMLFormElement;
  const chatInput = document.getElementById(
    "chat-input"
  ) as HTMLTextAreaElement;
  const chatSubmit = document.getElementById(
    "chat-submit"
  ) as HTMLButtonElement;
  const chatLoading = document.getElementById("chat-loading");
  const chatError = document.getElementById("chat-error");
  const errorMessage = document.getElementById("error-message");
  const errorDismiss = document.getElementById("error-dismiss");

  const sourceSidebar = document.getElementById("source-sidebar");
  const sidebarContent = document.getElementById("sidebar-content");
  const sidebarClose = document.getElementById("sidebar-close");

  let isLoading = false;
  let currentSources: SourceReference[] = [];

  interface SourceReference {
    type: "rag" | "sqlite";
    reference: string;
    url: string;
    text?: string;
    score?: number;
  }

  interface ChatResponse {
    answer: string;
    sources: SourceReference[];
    query_type: "semantic" | "structured" | "hybrid";
    tool_used: "sqlite" | "rag" | "both" | "none";
  }

  function autoResize(textarea: HTMLTextAreaElement) {
    textarea.style.height = "auto";
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + "px";
  }

  chatInput?.addEventListener("input", () => autoResize(chatInput));
  chatInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      chatForm?.requestSubmit();
    }
  });

  errorDismiss?.addEventListener("click", hideError);
  sidebarClose?.addEventListener("click", closeSidebar);

  chatForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = chatInput?.value.trim();
    if (!message || isLoading) return;

    addMessage(message, "user");
    chatInput.value = "";
    autoResize(chatInput);
    setLoading(true);
    hideError();
    closeSidebar();

    try {
      const response = await sendMessage(message);
      currentSources = response.sources || [];
      addMessage(
        response.answer,
        "assistant",
        response.sources,
        response.query_type,
        response.tool_used
      );
    } catch (error) {
      showError(
        error instanceof Error ? error.message : "An unexpected error occurred"
      );
    } finally {
      setLoading(false);
    }
  });

  async function sendMessage(message: string): Promise<ChatResponse> {
    const response = await fetch(`${CHAT_API_URL}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
    });
    if (!response.ok) {
      const errorText = await response.text().catch(() => "Unknown error");
      throw new Error(`Request failed: ${response.status} - ${errorText}`);
    }
    return response.json();
  }

  function addMessage(
    content: string,
    type: "user" | "assistant" | "system",
    sources?: SourceReference[],
    queryType?: string,
    toolUsed?: "sqlite" | "rag" | "both" | "none"
  ) {
    // Wrap message in a row div to control alignment rigorously
    const rowEl = document.createElement("div");
    rowEl.className = `message-row message-${type}-row`;

    const messageEl = document.createElement("div");
    messageEl.className = `message message-${type}`;

    // IDENTITY
    const identityEl = document.createElement("div");
    identityEl.className = "message-identity";
    const avatarEl = document.createElement("div");
    const nameEl = document.createElement("span");
    nameEl.className = "sender-name";

    if (type === "user") {
      avatarEl.className = "avatar user-avatar";
      avatarEl.textContent = "üë§";
      nameEl.textContent = "You";
    } else if (type === "assistant") {
      avatarEl.className = "avatar assistant-avatar";
      avatarEl.textContent = "üßô‚Äç‚ôÇÔ∏è";
      nameEl.textContent = "DM";
    }

    if (type !== "system") {
      identityEl.appendChild(avatarEl);
      identityEl.appendChild(nameEl);
      messageEl.appendChild(identityEl);
    }

    // CONTENT
    const contentEl = document.createElement("div");
    contentEl.className = "message-content";

    if (type === "assistant") {
      const markdownHtml = marked.parse(content) as string;
      const markdownWrapper = document.createElement("div");
      markdownWrapper.className = "markdown-content";
      markdownWrapper.innerHTML = markdownHtml;
      contentEl.appendChild(markdownWrapper);
    } else {
      const paragraphs = content.split("\n\n").filter((p) => p.trim());
      paragraphs.forEach((p) => {
        const pEl = document.createElement("p");
        pEl.textContent = p.trim();
        contentEl.appendChild(pEl);
      });
    }

    // Sources & Badges
    if (type === "assistant" && (sources?.length || toolUsed)) {
      const sourcesEl = document.createElement("div");
      sourcesEl.className = "message-sources";

      if (toolUsed && toolUsed !== "none") {
        const toolBadge = document.createElement("span");
        toolBadge.className = `tool-badge ${toolUsed}`;
        const toolIcon =
          toolUsed === "sqlite" ? "üìä" : toolUsed === "rag" ? "üîç" : "‚ö°";
        const toolLabel =
          toolUsed === "both" ? "SQLite + RAG" : toolUsed.toUpperCase();
        toolBadge.innerHTML = `${toolIcon} ${toolLabel}`;
        sourcesEl.appendChild(toolBadge);
      }

      if (sources && sources.length > 0) {
        const label = document.createElement("span");
        label.className = "sources-label";
        label.textContent = "Sources:";
        sourcesEl.appendChild(label);

        sources.forEach((source, index) => {
          const btn = document.createElement("button");
          btn.className = `source-btn ${source.type}`;
          btn.textContent = `${index + 1}`;
          btn.title = source.reference;
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            showSourceInSidebar(index);
          });
          sourcesEl.appendChild(btn);
        });
      }
      contentEl.appendChild(sourcesEl);
    }

    messageEl.appendChild(contentEl);
    rowEl.appendChild(messageEl); // Add bubble to row
    chatMessages?.appendChild(rowEl); // Add row to chat

    scrollToBottom();
  }

  function showSourceInSidebar(index: number) {
    const source = currentSources[index];
    if (!source) return;

    if (sidebarContent) {
      sidebarContent.innerHTML = `
        <div class="sidebar-source-meta">
          <span class="sidebar-source-badge ${source.type}">${source.type}</span>
          ${source.score !== undefined ? `<span class="sidebar-source-score">${(source.score * 100).toFixed(1)}% Match</span>` : ""}
          <div class="sidebar-source-ref">${source.reference}</div>
        </div>
        <div class="sidebar-source-text">${source.text || "No preview available."}</div>
        <a href="${source.url}" target="_blank" rel="noopener noreferrer" class="sidebar-source-link">üìÇ View on GitHub ‚Üí</a>
      `;
    }
    openSidebar();
  }

  function openSidebar() {
    sourceSidebar?.classList.add("open");
  }
  function closeSidebar() {
    sourceSidebar?.classList.remove("open");
  }
  function scrollToBottom() {
    if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function setLoading(loading: boolean) {
    isLoading = loading;
    if (chatSubmit) chatSubmit.disabled = loading;
    if (chatLoading) {
      chatLoading.classList.toggle("visible", loading);
      chatLoading.setAttribute("aria-hidden", (!loading).toString());
    }
    if (chatInput) chatInput.disabled = loading;
  }

  function showError(message: string) {
    if (errorMessage) errorMessage.textContent = message;
    if (chatError) {
      chatError.classList.add("visible");
      chatError.setAttribute("aria-hidden", "false");
    }
  }

  function hideError() {
    if (chatError) {
      chatError.classList.remove("visible");
      chatError.setAttribute("aria-hidden", "true");
    }
  }

  scrollToBottom();
</script>
